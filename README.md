# Тестовый кластер k8s

## Описание
Скрипт для развертывания локального кластера kubernetes "с нуля" на 3-х виртуальных машинах. Скрипт реализует следующие шаги:
1. создает 3 виртуальные машины в VirtualBox
2. создает конфиги cloud-init для автоматической установки Ubuntu
3. запускает веб-сервер с конфигами cloud-init для возможности автоматической установки OS. В конфигах прописаны следующие шаги:
   - установка названия узла
   - создание пользователя и пароля к нему
   - установка статического IPv4 - адреса
   - добавление подключения через NAT для доступа к Интернет
   - установка SSH-сервера и добавление SSH-ключа пользователя в доверенные на всех узлах
4. запускает виртуальные машины с параметрами автоматической установки
5. запускает скрипт ожидания доступности всех виртуальных машин, после установки
6. запускает плейбуки Ansible:
   - начальная настройка всех узлов
   - настройка сети узлов
   - установка CRI-O как runtime для контейнеров
   - установка компонентов k8s на все узлы
   - установка control-plane роли на первый узел
   - добавление Flannel, как CNI-провайдера
   - присоединение 2 и 3 узлов к кластеру
7. Выключает веб-сервер автоматической установки

## Требования на локальной машине
- Docker
- Virtualbox >= 7.0 (Более старые версии не поддерживают автоматическую установку ОС без Selinux)
- Python >= 3.8 (с поддержкой модуля "venv")
- GNU Make (Поэтому скрипт работает только на OS Linux и MacOS)
- ISO-образ с Ubuntu Server >= 22.04

## Запуск
1. В Virtualbox создаем Host-only Network (пока не автоматизировано):
   - Tools -> Network -> вкладка "Host-only Network" -> Create
   - Переключатель "Configure Adapter Manually"
   - `IPv4 Address` = 192.168.60.1
   - `IPv4 Network Mask` = 255.255.255.0
   - `DHCP Server` = `Enable Server`
2. Копируем файл `.env.example` в корень проекта с именем `.env`
3. В директорию `configuration` создаем файл `private_key.pem` с приватным ключом SSH, открытый ключ которого, вы записали в `.env` в переменную `AUTHORIZED_SSH_KEY`
4. Выполняем команду
```shell
make reset_cluster
```
Она создаст виртуальные машины и настроит на них кластер кубера
5. В корне проекта появится файл `cluster_config.yaml` с настройками подключения к кластеру, его можно использовать для управления кластером с локальной машины через `kubectl`
